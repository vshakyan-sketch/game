<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ó–º–µ–π–∫–∞ ‚Ä¢ –ø–ª–∞–≤–Ω–∞—è</title>
    <style>
        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            margin: 0;
            min-height: 100vh;
            background: radial-gradient(circle at 20% 30%, #1a3a3a, #0b1a1f);
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
        }
        .game-wrapper {
            width: min(98vw, 500px);
            padding: 12px;
            background: rgba(10, 25, 30, 0.9);
            backdrop-filter: blur(4px);
            border-radius: 40px;
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6), inset 0 0 0 1px rgba(80, 140, 130, 0.5);
        }
        .canvas-container {
            display: flex;
            justify-content: center;
            border-radius: 32px;
            overflow: hidden;
            box-shadow: inset 0 0 20px #00000040, 0 10px 15px #00000060;
        }
        canvas {
            width: 100%;
            height: auto;
            aspect-ratio: 1/1;
            display: block;
            background: #142026;
            touch-action: none;
        }
        .score-panel {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 8px 8px;
            color: #deeeff;
            font-weight: 600;
            font-size: 1.4rem;
            text-shadow: 0 2px 5px #00000080;
        }
        #restartBtn {
            background: #2d4f4a;
            border: none;
            color: #f0faf0;
            font-size: 1.2rem;
            padding: 10px 22px;
            border-radius: 60px;
            font-weight: bold;
            box-shadow: 0 6px 0 #1a302c, 0 8px 12px black;
            cursor: pointer;
            transition: 0.07s ease;
            border: 1px solid #55a090;
            letter-spacing: 0.5px;
        }
        #restartBtn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #1a302c, 0 5px 10px black;
        }
        .direction-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 12px;
            gap: 8px;
        }
        .direction-row {
            display: flex;
            justify-content: center;
            gap: 18px;
        }
        .dir-btn {
            width: 75px;
            height: 75px;
            background: #1c3a42;
            border: none;
            color: #ddeff5;
            font-size: 2.7rem;
            border-radius: 30px;
            box-shadow: 0 9px 0 #0b2025, 0 10px 18px black;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.06s linear;
            touch-action: manipulation;
            border: 2px solid #3e7b82;
            text-shadow: 0 3px 3px black;
            font-weight: 600;
        }
        .dir-btn:active {
            transform: translateY(9px);
            box-shadow: 0 2px 0 #0b2025, 0 8px 12px black;
        }
        @media (max-width: 450px) {
            .dir-btn {
                width: 65px;
                height: 65px;
                font-size: 2.3rem;
            }
            .score-panel {
                font-size: 1.2rem;
            }
        }
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å—Å–∞—Ü–∏–∏ –¥–ª—è —Å—á—ë—Ç–∞ */
        .score-value {
            display: inline-block;
            transition: transform 0.2s;
        }
        .pop {
            transform: scale(1.3);
            color: #ffd966;
        }
    </style>
</head>
<body>
<div class="game-wrapper">
    <div class="canvas-container">
        <canvas id="gameCanvas" width="400" height="400"></canvas>
    </div>
    <div class="score-panel">
        <span>üçé <span id="scoreDisplay" class="score-value">0</span></span>
        <button id="restartBtn">‚ü≥ –ù–æ–≤–∞—è –∏–≥—Ä–∞</button>
    </div>
    <div class="direction-panel">
        <div class="direction-row">
            <button class="dir-btn" id="btnUp">‚ñ≤</button>
        </div>
        <div class="direction-row">
            <button class="dir-btn" id="btnLeft">‚óÄ</button>
            <button class="dir-btn" id="btnDown">‚ñº</button>
            <button class="dir-btn" id="btnRight">‚ñ∂</button>
        </div>
    </div>
</div>

<script>
    (function() {
        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        const GRID_SIZE = 20;                  // –ø–æ–ª–µ 20x20
        const CANVAS_SIZE = 400;                // –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä canvas (–¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤)
        const TICK_INTERVAL_MS = 160;            // –ª–æ–≥–∏—á–µ—Å–∫–∏–π —Ç–∏–∫ (–º—Å)
        const ANIMATION_DURATION = TICK_INTERVAL_MS; // –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞ (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–∏–∫–æ–º)

        // --- –≠–õ–ï–ú–ï–ù–¢–´ ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreSpan = document.getElementById('scoreDisplay');
        const restartBtn = document.getElementById('restartBtn');

        // –ö–Ω–æ–ø–∫–∏
        const btnUp = document.getElementById('btnUp');
        const btnDown = document.getElementById('btnDown');
        const btnLeft = document.getElementById('btnLeft');
        const btnRight = document.getElementById('btnRight');

        // --- –ò–ì–†–û–í–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        // –î–∏—Å–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–ª–æ–≥–∏–∫–∞)
        let snake = [];                         // –º–∞—Å—Å–∏–≤ –∫–ª–µ—Ç–æ–∫ {x, y} (–≥–æ–ª–æ–≤–∞ –≤ –∏–Ω–¥–µ–∫—Å–µ 0)
        let food = { x: 0, y: 0 };
        let direction = 'RIGHT';
        let nextDirection = 'RIGHT';
        let score = 0;
        let gameOver = false;

        // –î–ª—è –ø–ª–∞–≤–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏: —Ö—Ä–∞–Ω–∏–º —Ç–µ–∫—É—â–∏–µ —Ä–∏—Å—É–µ–º—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (–∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
        let animatedSnake = [];                  // –º–∞—Å—Å–∏–≤ {x, y} —Å –ø–ª–∞–≤–∞—é—â–∏–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        let animatedFood = { x: 0, y: 0 };

        // –¶–µ–ª–µ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ª–æ–≥–∏—á–µ—Å–∫–∏–º –ø–æ—Å–ª–µ —à–∞–≥–∞)
        let targetSnake = [];
        let targetFood = { x: 0, y: 0 };

        // –í—Ä–µ–º—è –∞–Ω–∏–º–∞—Ü–∏–∏
        let lastTickTime = performance.now();
        let animProgress = 1.0;                   // –æ—Ç 0 –¥–æ 1 (1 - –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
        let tickPending = false;                  // —Ñ–ª–∞–≥, —á—Ç–æ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ç–∏–∫

        // –¢–∞–π–º–µ—Ä—ã
        let gameInterval = null;
        let rafId = null;

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function randomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –µ–¥—ã –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π –∫–ª–µ—Ç–∫–µ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ)
        function generateFood() {
            const totalCells = GRID_SIZE * GRID_SIZE;
            if (snake.length >= totalCells) {
                gameOver = true;
                return false;
            }

            const snakeSet = new Set(snake.map(cell => `${cell.x},${cell.y}`));
            let freeCells = [];
            for (let i = 0; i < GRID_SIZE; i++) {
                for (let j = 0; j < GRID_SIZE; j++) {
                    if (!snakeSet.has(`${i},${j}`)) {
                        freeCells.push({ x: i, y: j });
                    }
                }
            }
            if (freeCells.length === 0) {
                gameOver = true;
                return false;
            }
            const randIndex = Math.floor(Math.random() * freeCells.length);
            food = freeCells[randIndex];
            return true;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä—ã
        function initGame() {
            // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–º–µ–π–∫–∞ –∏–∑ 3 –∫–ª–µ—Ç–æ–∫
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 }
            ];
            direction = 'RIGHT';
            nextDirection = 'RIGHT';
            score = 0;
            gameOver = false;
            scoreSpan.textContent = '0';
            generateFood();

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ —Ä–∞–≤–Ω—ã–º–∏ –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–º
            animatedSnake = snake.map(p => ({ x: p.x, y: p.y }));
            animatedFood = { ...food };

            targetSnake = snake.map(p => ({ ...p }));
            targetFood = { ...food };

            animProgress = 1.0; // —Å—Ç–æ–∏–º –Ω–∞ –º–µ—Å—Ç–µ
            lastTickTime = performance.now();
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è (–Ω–µ–ª—å–∑—è —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å—Å—è)
        function canChangeDirection(newDir, currentDir) {
            if (currentDir === 'UP' && newDir === 'DOWN') return false;
            if (currentDir === 'DOWN' && newDir === 'UP') return false;
            if (currentDir === 'LEFT' && newDir === 'RIGHT') return false;
            if (currentDir === 'RIGHT' && newDir === 'LEFT') return false;
            return true;
        }

        function setDirection(newDir) {
            if (gameOver) return;
            if (canChangeDirection(newDir, direction)) {
                nextDirection = newDir;
            }
        }

        // --- –õ–û–ì–ò–ß–ï–°–ö–ò–ô –®–ê–ì (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ —Ç–∞–π–º–µ—Ä—É) ---
        function gameTick() {
            if (gameOver) return;

            // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            direction = nextDirection;

            // –ù–æ–≤–∞—è –≥–æ–ª–æ–≤–∞
            const head = snake[0];
            let newHead = { ...head };
            switch (direction) {
                case 'UP':    newHead.y -= 1; break;
                case 'DOWN':  newHead.y += 1; break;
                case 'LEFT':  newHead.x -= 1; break;
                case 'RIGHT': newHead.x += 1; break;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–Ω–∏—Ü
            if (newHead.x < 0 || newHead.x >= GRID_SIZE || newHead.y < 0 || newHead.y >= GRID_SIZE) {
                gameOver = true;
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—ä–µ–ª–∏ –ª–∏ –µ–¥—É
            const isEating = (newHead.x === food.x && newHead.y === food.y);

            // –í—Å—Ç–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –≥–æ–ª–æ–≤—É
            snake.unshift(newHead);

            // –ï—Å–ª–∏ –Ω–µ –µ–ª–∏ ‚Äî —É–¥–∞–ª—è–µ–º —Ö–≤–æ—Å—Ç
            if (!isEating) {
                snake.pop();
            } else {
                // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç
                score += 1;
                scoreSpan.textContent = score;
                // –ê–Ω–∏–º–∞—Ü–∏—è "pop" –¥–ª—è —Å—á—ë—Ç–∞
                scoreSpan.classList.add('pop');
                setTimeout(() => scoreSpan.classList.remove('pop'), 150);

                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—É—é –µ–¥—É
                const success = generateFood();
                if (!success || gameOver) {
                    // –ï—Å–ª–∏ –ø–æ–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ, gameOver —É–∂–µ true
                    return;
                }
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å —Ç–µ–ª–æ–º (–≥–æ–ª–æ–≤–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ—Å—Ç–∞–ª—å–Ω—ã–º–∏)
            const headPos = snake[0];
            for (let i = 1; i < snake.length; i++) {
                if (snake[i].x === headPos.x && snake[i].y === headPos.y) {
                    gameOver = true;
                    break;
                }
            }

            // –ü–æ—Å–ª–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —à–∞–≥–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–ª–µ–≤—ã–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
            targetSnake = snake.map(p => ({ ...p }));
            targetFood = { ...food };
        }

        // --- –§–£–ù–ö–¶–ò–Ø –ê–ù–ò–ú–ê–¶–ò–ò (requestAnimationFrame) ---
        function animate(now) {
            rafId = requestAnimationFrame(animate);

            if (!gameOver) {
                // –í—ã—á–∏—Å–ª—è–µ–º, —Å–∫–æ–ª—å–∫–æ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º–µ–Ω–∏ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ç–∏–∫–∞
                const timeSinceLastTick = now - lastTickTime;

                // –ï—Å–ª–∏ –ø—Ä–∏—à–ª–æ –≤—Ä–µ–º—è –¥–ª—è –Ω–æ–≤–æ–≥–æ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —Ç–∏–∫–∞
                if (timeSinceLastTick >= TICK_INTERVAL_MS) {
                    // –°–¥–≤–∏–≥–∞–µ–º –≤—Ä–µ–º—è, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
                    lastTickTime = now - (timeSinceLastTick % TICK_INTERVAL_MS);

                    // –í—ã–ø–æ–ª–Ω—è–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏–π —à–∞–≥
                    gameTick();

                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏
                    animProgress = 0.0;
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–Ω–∏–º–∞—Ü–∏–∏ (–ª–∏–Ω–µ–π–Ω–æ)
                if (animProgress < 1.0) {
                    const delta = (now - lastTickTime) / ANIMATION_DURATION;
                    animProgress = Math.min(delta, 1.0);
                }
            }

            // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
            if (!gameOver && animProgress < 1.0 && targetSnake.length > 0) {
                // –ò–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π —Å–µ–≥–º–µ–Ω—Ç –∑–º–µ–π–∫–∏ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ (animatedSnake) –∫ —Ü–µ–ª–µ–≤–æ–º—É (targetSnake)
                // –ù–æ –ø—Ä–æ—â–µ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞—Ç—å –º–µ–∂–¥—É –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (–∫–æ—Ç–æ—Ä–æ–µ –º—ã –Ω–µ —Ö—Ä–∞–Ω–∏–º) –∏ —Ü–µ–ª–µ–≤—ã–º.
                // –ú—ã –º–æ–∂–µ–º —Ö—Ä–∞–Ω–∏—Ç—å "startSnake" –≤ –º–æ–º–µ–Ω—Ç –Ω–∞—á–∞–ª–∞ —Ç–∏–∫–∞. –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
                // —Ç–æ—Ç —Ñ–∞–∫—Ç, —á—Ç–æ animatedSnake —É–∂–µ —Ö—Ä–∞–Ω–∏—Ç –ø–æ–∑–∏—Ü–∏–∏ –ø–æ—Å–ª–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏,
                // –∏ –∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä—É–µ–º –æ—Ç –Ω–∏—Ö –∫ targetSnake. –≠—Ç–æ –º–æ–∂–µ—Ç –≤—ã–∑–≤–∞—Ç—å –Ω–µ–±–æ–ª—å—à—É—é –∏–Ω–µ—Ä—Ü–∏—é, –Ω–æ –±—É–¥–µ—Ç –ø–ª–∞–≤–Ω–æ.
                for (let i = 0; i < targetSnake.length; i++) {
                    const target = targetSnake[i];
                    const current = animatedSnake[i] || target; // –µ—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç –¥–ª–∏–Ω–∞
                    animatedSnake[i] = {
                        x: current.x + (target.x - current.x) * 0.25, // –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
                        y: current.y + (target.y - current.y) * 0.25
                    };
                    // –ï—Å–ª–∏ –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ –∫ —Ü–µ–ª–∏, –ø—Ä–∏—Ä–∞–≤–Ω–∏–≤–∞–µ–º
                    if (Math.abs(animatedSnake[i].x - target.x) < 0.01) animatedSnake[i].x = target.x;
                    if (Math.abs(animatedSnake[i].y - target.y) < 0.01) animatedSnake[i].y = target.y;
                }

                // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –µ–¥—ã
                animatedFood.x += (targetFood.x - animatedFood.x) * 0.25;
                animatedFood.y += (targetFood.y - animatedFood.y) * 0.25;
                if (Math.abs(animatedFood.x - targetFood.x) < 0.01) animatedFood.x = targetFood.x;
                if (Math.abs(animatedFood.y - targetFood.y) < 0.01) animatedFood.y = targetFood.y;
            } else {
                // –ï—Å–ª–∏ –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∏–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å —Ü–µ–ª–µ–≤—ã–º–∏
                animatedSnake = targetSnake.map(p => ({ ...p }));
                animatedFood = { ...targetFood };
            }

            // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            drawScene();
        }

        // --- –û–¢–†–ò–°–û–í–ö–ê (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º animatedSnake –∏ animatedFood) ---
        function drawScene() {
            ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
            const cellSize = CANVAS_SIZE / GRID_SIZE;

            // –†–∏—Å—É–µ–º —Ç—ë–º–Ω—É—é –ø–æ–¥–ª–æ–∂–∫—É —Å —Å–µ—Ç–∫–æ–π (–º—è–≥–∫–∏–µ –ª–∏–Ω–∏–∏)
            ctx.fillStyle = '#142026';
            ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

            // –†–∏—Å—É–µ–º –æ—á–µ–Ω—å —Ç–æ–Ω–∫—É—é —Å–µ—Ç–∫—É
            ctx.beginPath();
            ctx.strokeStyle = '#2d4a55';
            ctx.lineWidth = 0.6;
            for (let i = 0; i <= GRID_SIZE; i++) {
                ctx.moveTo(i * cellSize, 0);
                ctx.lineTo(i * cellSize, CANVAS_SIZE);
                ctx.moveTo(0, i * cellSize);
                ctx.lineTo(CANVAS_SIZE, i * cellSize);
            }
            ctx.stroke();

            // –†–∏—Å—É–µ–º –∑–º–µ–π–∫—É (—Å –ø–ª–∞–≤–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏)
            for (let i = 0; i < animatedSnake.length; i++) {
                const seg = animatedSnake[i];
                const isHead = (i === 0);
                const x = seg.x * cellSize;
                const y = seg.y * cellSize;

                // –ì—Ä–∞–¥–∏–µ–Ω—Ç –¥–ª—è –æ–±—ä—ë–º–∞
                const gradient = ctx.createRadialGradient(x+3, y+3, 2, x+cellSize/2, y+cellSize/2, cellSize/1.5);
                if (isHead) {
                    gradient.addColorStop(0, '#b0e57c');
                    gradient.addColorStop(1, '#4f9e4a');
                } else {
                    gradient.addColorStop(0, '#6dad5a');
                    gradient.addColorStop(1, '#2f7540');
                }

                ctx.shadowColor = isHead ? '#d0ffb0' : '#60a080';
                ctx.shadowBlur = isHead ? 16 : 8;
                ctx.fillStyle = gradient;

                // –†–∏—Å—É–µ–º –∑–∞–∫—Ä—É–≥–ª—ë–Ω–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç (–∫–∞–ø—Å—É–ª–∞)
                const padding = 2;
                const radius = Math.min(cellSize/3, 8);
                ctx.beginPath();
                ctx.roundRect(x + padding/2, y + padding/2, cellSize - padding, cellSize - padding, radius);
                ctx.fill();

                // –ì–ª–∞–∑–∫–∏ —É –≥–æ–ª–æ–≤—ã
                if (isHead) {
                    ctx.shadowBlur = 0;
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(x + cellSize*0.35, y + cellSize*0.35, cellSize*0.12, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + cellSize*0.65, y + cellSize*0.35, cellSize*0.1, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.fillStyle = '#0a1a1a';
                    ctx.beginPath();
                    ctx.arc(x + cellSize*0.33, y + cellSize*0.33, cellSize*0.06, 0, 2*Math.PI);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(x + cellSize*0.63, y + cellSize*0.33, cellSize*0.05, 0, 2*Math.PI);
                    ctx.fill();
                }
            }

            // –†–∏—Å—É–µ–º –µ–¥—É (–ø—É–ª—å—Å–∏—Ä—É—é—â–∏–π —Ñ—Ä—É–∫—Ç)
            const fx = animatedFood.x * cellSize;
            const fy = animatedFood.y * cellSize;
            const pulse = 1 + 0.1 * Math.sin(performance.now() / 200); // –ø—É–ª—å—Å–∞—Ü–∏—è

            ctx.shadowColor = '#ff6f6f';
            ctx.shadowBlur = 20;
            const foodGrad = ctx.createRadialGradient(fx+5, fy+5, 3, fx+cellSize/2, fy+cellSize/2, cellSize/2 * pulse);
            foodGrad.addColorStop(0, '#ffb347');
            foodGrad.addColorStop(0.7, '#e63946');
            ctx.fillStyle = foodGrad;

            ctx.beginPath();
            ctx.arc(fx + cellSize/2, fy + cellSize/2, cellSize/2.2 * pulse, 0, 2 * Math.PI);
            ctx.fill();

            // –õ–∏—Å—Ç–∏–∫
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#7cfc00';
            ctx.beginPath();
            ctx.ellipse(fx + cellSize/2.5, fy + cellSize/3.5, cellSize/8, cellSize/12, 0.2, 0, 2*Math.PI);
            ctx.fill();

            // –ï—Å–ª–∏ –∏–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ ‚Äî –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –∏ –Ω–∞–¥–ø–∏—Å—å
            if (gameOver) {
                ctx.shadowBlur = 0;
                ctx.fillStyle = 'rgba(0,0,0,0.6)';
                ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                ctx.fillStyle = '#ffe9d0';
                ctx.font = 'bold 28px "Segoe UI", Roboto, sans-serif';
                ctx.shadowColor = '#000000';
                ctx.shadowBlur = 14;
                ctx.fillText('‚ò†Ô∏è –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞', 45, 220);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è —Å–∫—Ä—É–≥–ª—ë–Ω–Ω—ã—Ö –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫–æ–≤
        CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
            if (w < 2 * r) r = w / 2;
            if (h < 2 * r) r = h / 2;
            this.moveTo(x + r, y);
            this.lineTo(x + w - r, y);
            this.quadraticCurveTo(x + w, y, x + w, y + r);
            this.lineTo(x + w, y + h - r);
            this.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
            this.lineTo(x + r, y + h);
            this.quadraticCurveTo(x, y + h, x, y + h - r);
            this.lineTo(x, y + r);
            this.quadraticCurveTo(x, y, x + r, y);
            return this;
        };

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï ---
        window.addEventListener('keydown', (e) => {
            const key = e.key;
            e.preventDefault();
            if (key === 'ArrowUp') setDirection('UP');
            else if (key === 'ArrowDown') setDirection('DOWN');
            else if (key === 'ArrowLeft') setDirection('LEFT');
            else if (key === 'ArrowRight') setDirection('RIGHT');
        });

        // –°–≤–∞–π–ø—ã
        let touchStartX = 0, touchStartY = 0;
        const SWIPE_THRESH = 20;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
        }, { passive: false });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            if (!touchStartX || !touchStartY) return;
            const touchEnd = e.changedTouches[0];
            const dx = touchEnd.clientX - touchStartX;
            const dy = touchEnd.clientY - touchStartY;

            if (Math.abs(dx) < SWIPE_THRESH && Math.abs(dy) < SWIPE_THRESH) return;

            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0) setDirection('RIGHT');
                else setDirection('LEFT');
            } else {
                if (dy > 0) setDirection('DOWN');
                else setDirection('UP');
            }

            touchStartX = 0; touchStartY = 0;
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        // –ö–Ω–æ–ø–∫–∏
        btnUp.addEventListener('click', () => setDirection('UP'));
        btnDown.addEventListener('click', () => setDirection('DOWN'));
        btnLeft.addEventListener('click', () => setDirection('LEFT'));
        btnRight.addEventListener('click', () => setDirection('RIGHT'));

        // –†–µ—Å—Ç–∞—Ä—Ç
        restartBtn.addEventListener('click', () => {
            stopGame();
            initGame();
            startGame();
        });

        // --- –ó–ê–ü–£–°–ö –ò –û–°–¢–ê–ù–û–í–ö–ê ---
        function stopGame() {
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            if (rafId) {
                cancelAnimationFrame(rafId);
                rafId = null;
            }
        }

        function startGame() {
            lastTickTime = performance.now();
            animProgress = 1.0; // –Ω–∞—á–∏–Ω–∞–µ–º —Å –∑–∞–≤–µ—Ä—à—ë–Ω–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–∏
            // –¢–∞–π–º–µ—Ä –¥–ª—è –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–∏–∫–æ–≤
            gameInterval = setInterval(() => {
                // –¢–æ–ª—å–∫–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –ø–æ—Ä–∞ —Å–¥–µ–ª–∞—Ç—å —Ç–∏–∫ (–Ω–æ —Ç–∏–∫ –¥–µ–ª–∞–µ–º –≤ –∞–Ω–∏–º–∞—Ü–∏–∏)
                // –ù–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –æ—Å—Ç–∞–≤–∏–º –≤—ã–∑–æ–≤ gameTick –∑–¥–µ—Å—å, –Ω–æ –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π.
                // –õ—É—á—à–µ —É–ø—Ä–∞–≤–ª—è—Ç—å –≤—Ä–µ–º–µ–Ω–µ–º –≤ animation loop, –∫–∞–∫ –º—ã –∏ —Å–¥–µ–ª–∞–ª–∏.
                // –û–¥–Ω–∞–∫–æ setInterval –±—É–¥–µ—Ç –≤–Ω–æ—Å–∏—Ç—å —Å–≤–æ–π —Ç–∏–∫ –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∞–Ω–∏–º–∞—Ü–∏–∏.
                // –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤, –º—ã —É–±–µ—Ä—ë–º setInterval –∏ –±—É–¥–µ–º –ø–æ–ª–∞–≥–∞—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ requestAnimationFrame —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –≤—Ä–µ–º–µ–Ω–∏.
                // –¢–∞–∫ –∏ —Å–¥–µ–ª–∞–µ–º: gameInterval –Ω–µ –Ω—É–∂–µ–Ω.
            }, TICK_INTERVAL_MS);
            // –í–º–µ—Å—Ç–æ setInterval –º—ã —É–∂–µ –≤—Å—ë –¥–µ–ª–∞–µ–º –≤ animate –ø–æ –≤—Ä–µ–º–µ–Ω–∏.
            // –û—á–∏—Å—Ç–∏–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª, –µ—Å–ª–∏ –±—ã–ª.
            if (gameInterval) {
                clearInterval(gameInterval);
                gameInterval = null;
            }
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ü–∏–∫–ª
            rafId = requestAnimationFrame(animate);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞—Ä—Ç
        initGame();
        startGame();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–∞—É–∑–∞ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è, –Ω–æ –º–æ–∂–Ω–æ)
        window.addEventListener('blur', () => {});
        window.addEventListener('focus', () => {});
    })();
</script>
</body>
</html>
